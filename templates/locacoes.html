{% extends "base.html" %}
{% block title %}Locações Ativas{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Locações Ativas</h2>
  <a class="btn btn-outline-secondary" href="{{ url_for('locacoes.canceladas') }}">
    <i class="fa-solid fa-list me-1"></i>Ver Canceladas
  </a>
</div>

<!-- Formulário nova locação -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <i class="fa-solid fa-plus me-1"></i> Nova Locação
  </div>
  <div class="card-body">
    <form method="POST" enctype="multipart/form-data">
      <div class="row g-3">
        <div class="col-md-4">
          <label for="cliente_id" class="form-label">Cliente</label>
          <select id="cliente_id" name="cliente_id" class="form-select" required>
            <option value="">Selecione</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label for="moto_id" class="form-label">Moto (Modelo - Placa)</label>
          <select id="moto_id" name="moto_id" class="form-select" required>
            <option value="">Selecione</option>
            {% for moto in motos %}
            <option value="{{ moto.id }}">{{ moto.modelo }} - {{ moto.placa }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label for="data_inicio" class="form-label">Data Início</label>
          <input id="data_inicio" type="date" name="data_inicio" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label for="valor" class="form-label">Valor (R$)</label>
          <input id="valor" type="number" name="valor" min="0" step="0.01" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="frequencia_pagamento" class="form-label">Frequência de Pagamento</label>
          <select id="frequencia_pagamento" name="frequencia_pagamento" class="form-select" required>
            <option value="">Selecione...</option>
            <option value="WEEKLY">Semanal</option>
            <option value="MONTHLY">Mensal</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="observacoes" class="form-label">Observações</label>
          <textarea id="observacoes" name="observacoes" class="form-control"></textarea>
        </div>
        <div class="col-md-12">
          <label for="contrato_pdf" class="form-label">Contrato (PDF)</label>
          <input id="contrato_pdf" type="file" name="contrato_pdf" accept="application/pdf" class="form-control">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success mt-2">
            <i class="fa-solid fa-save me-1"></i> Cadastrar Locação
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Listagem -->
<div class="card">
  <div class="card-header bg-dark text-white">
    <i class="fa-solid fa-table-list me-1"></i> Locações Ativas
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Moto</th>
            <th>Placa</th>
            <th>Início</th>
            <th>Fim</th>
            <th>Frequência</th>
            <th>Contrato</th>
            <th>Boleto</th>
            <th>Status</th>
            <th>Valor Pago</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for locacao in locacoes %}
          <tr>
            <td>{{ locacao.id }}</td>
            <td>{{ locacao.cliente_nome }}</td>
            <td>{{ locacao.moto_modelo }}</td>
            <td>{{ locacao.moto_placa }}</td>
            <td>
              {% if locacao.data_inicio %}
                {{ locacao.data_inicio.strftime('%d/%m/%Y') if locacao.data_inicio.__class__.__name__ in ['date', 'datetime'] else locacao.data_inicio }}
              {% else %}-{% endif %}
            </td>
            <td>
              {% if locacao.data_fim %}
                {{ locacao.data_fim.strftime('%d/%m/%Y') if locacao.data_fim.__class__.__name__ in ['date', 'datetime'] else locacao.data_fim }}
              {% else %}-{% endif %}
            </td>
            <td>
              {% if locacao.frequencia_pagamento == 'WEEKLY' %}Semanal
              {% elif locacao.frequencia_pagamento == 'MONTHLY' %}Mensal
              {% else %}-{% endif %}
            </td>
            <td>
              <a class="btn btn-sm btn-outline-dark"
                 href="{{ url_for('locacoes.contrato_pdf', locacao_id=locacao.id) }}"
                 target="_blank" title="Ver Contrato">
                <i class="fa-solid fa-file-pdf"></i>
              </a>
            </td>
            <td>
              {% if locacao.boleto_url %}
              <a class="btn btn-sm btn-success" href="{{ locacao.boleto_url }}" target="_blank" title="Ver Boleto">
                <i class="fa-solid fa-barcode"></i>
              </a>
              {% else %}
              <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if locacao.pagamento_status %}
              <span class="badge bg-{% if locacao.pagamento_status == 'RECEIVED' %}success{% elif locacao.pagamento_status == 'PENDING' %}warning{% elif locacao.pagamento_status == 'OVERDUE' %}danger{% else %}secondary{% endif %}">
                {{ locacao.pagamento_status }}
              </span>
              {% else %}
              <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if locacao.valor_pago %}
              R$ {{ "%.2f"|format(locacao.valor_pago) }}
              {% else %}
              <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group" role="group">
                <a href="{{ url_for('locacoes.editar_locacao', id=locacao.id) }}" class="btn btn-sm btn-warning" title="Editar">
                  <i class="fa-solid fa-edit"></i>
                </a>
                <form action="{{ url_for('locacoes.cancelar_locacao', id=locacao.id) }}" method="POST" style="display:inline;">
                  <button type="submit" class="btn btn-sm btn-danger"
                          onclick="return confirm('Tem certeza que deseja cancelar esta locação?')" title="Cancelar">
                    <i class="fa-solid fa-ban"></i>
                  </button>
                </form>
                <a href="{{ url_for('servicos.listar_servicos', locacao_id=locacao.id) }}"
                   class="btn btn-sm btn-info" title="Serviços">
                  <i class="fa-solid fa-wrench"></i>
                </a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="12" class="text-center text-muted">Nenhuma locação ativa encontrada.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}